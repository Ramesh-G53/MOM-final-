<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Masters of Minds</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@9.0.0/dist/umd/uuidv4.min.js"></script>
    <style>
        /* blog upload form */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            /* padding: 0px; */
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .admin-container {
            background: white;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .admin-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 30px;
            position: relative;
            text-align: center;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 16px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .control-btn.logout {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .control-btn.logout:hover {
            background: rgba(231, 76, 60, 0.1);
        }

        .admin-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding-top: 20px;
        }

        .admin-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .welcome-section {
            background: #f8f9fa;
            padding: 20px 30px;
            text-align: center;
        }

        .welcome-message {
            color: #2c3e50;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .user-info {
            color: #7f8c8d;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .admin-content {
            padding: 30px;
            background: white;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .footer-info {
            background: #f8f9fa;
            padding: 20px 30px;
            text-align: center;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Blog Components */
        .upload-form {
            margin: 0 0 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group input[type="date"],
        .form-group input[type="time"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .button.delete {
            background-color: #e74c3c;
        }

        .button.delete:hover {
            background-color: #c0392b;
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .preview-item {
            position: relative;
            width: 150px;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background-color: rgba(231, 76, 60, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .blog-list {
            margin-top: 30px;
        }

        .section-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #f1f1f1;
            padding-bottom: 10px;
        }

        .blog-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }

        .blog-item:hover {
            background-color: #f9f9f9;
        }

        .blog-info {
            flex-grow: 1;
        }

        .blog-info h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            color: #2c3e50;
        }

        .blog-date {
            color: #7f8c8d;
            font-size: 14px;
        }

        .no-blogs {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Event Components - Styled to match Blog Components */
        .event-management {
            margin-top: 40px;
            border-top: 2px solid #f1f1f1;
            padding-top: 30px;
        }

        .event-upload-form {
            margin: 0 0 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .event-list {
            margin-top: 30px;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }

        .event-item:hover {
            background-color: #f9f9f9;
        }

        .event-info {
            flex-grow: 1;
        }

        .event-info h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            color: #2c3e50;
        }

        .event-date {
            color: #7f8c8d;
            font-size: 14px;
        }

        .no-events {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .body {
                padding: 1px;
            }

            .admin-container {
                margin: 10px;
                border-radius: 10px;
            }

            .admin-header {
                padding: 25px 20px;
            }

            .header-controls {
                position: static;
                margin-top: 20px;
                margin-bottom: 20px;
                gap: 50px;
                justify-content: center;
            }

            .admin-title {
                font-size: 1.8rem;
                padding-top: 0;
            }

            .admin-subtitle {
                font-size: 1rem;
            }

            .admin-content,
            .welcome-section,
            .footer-info {
                padding: 20px 15px;
            }

            .control-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .image-preview {
                justify-content: center;
            }
            
            .preview-item {
                width: 120px;
                height: 120px;
            }
            
            .blog-item,
            .event-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .blog-item button,
            .event-item button {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="admin-container">
        <div class="admin-header">
            <div class="header-controls">
                <a href="index.html" class="control-btn">
                    ‚Üê Go Back
                </a>
                <button onclick="logout()" class="control-btn logout">
                    üö™ Logout
                </button>
            </div>
            
            <h1 class="admin-title">Admin Dashboard</h1>
            <p class="admin-subtitle">Manage your blog content</p>
        </div>

        <div class="welcome-section">
            <p class="welcome-message">
                <span class="status-indicator"></span>
                You are successfully logged in as an administrator
            </p>
            <p class="user-info" id="userInfo">
                Loading user information...
            </p>
        </div>

        <div class="admin-content">
            <div class="upload-form">
                <h2 class="section-title">Add New Blog Post</h2>
                <form id="uploadForm">
                    <div class="form-group">
                        <label for="blogTitle">Blog Title</label>
                        <input type="text" id="blogTitle" required placeholder="Enter blog title">
                    </div>
                    
                    <div class="form-group">
                        <label for="blogCaption">Blog Caption</label>
                        <textarea id="blogCaption" required placeholder="Enter blog caption"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="imageInput">Blog Images (Max 4)</label>
                        <input type="file" id="imageInput" accept="image/*" multiple>
                        <div class="image-preview" id="imagePreview"></div>
                    </div>
                    
                    <button type="submit" class="button">Post Blog</button>
                </form>
                <div id="uploadStatus"></div>
            </div>
            
            <div class="blog-list">
                <h2 class="section-title">Your Blog Posts</h2>
                <div id="blogList">
                    <div class="no-blogs">Loading blogs...</div>
                </div>
            </div>
        </div>

        <!-- Event Management Section -->
        <div class="admin-content">
            <div class="upload-form">
                <h2 class="section-title">Add New Event</h2>
                <form id="eventUploadForm">
                    <div class="form-group">
                        <label for="eventTitle">Event Title</label>
                        <input type="text" id="eventTitle" required placeholder="Enter event title">
                    </div>

                    <div class="form-group">
                        <label for="eventDate">Event Date</label>
                        <input type="date" id="eventDate" required>
                    </div>

                    <div class="form-group">
                        <label for="eventPosterInput">Event Poster</label>
                        <input type="file" id="eventPosterInput" accept="image/*" required>
                        <div class="image-preview" id="eventPosterPreview"></div>
                    </div>

                    <button type="submit" class="button">Add Event</button>
                </form>
                <div id="eventUploadStatus"></div>
            </div>

            <div class="blog-list">
                <h2 class="section-title">Your Events</h2>
                <div id="eventList">
                    <div class="no-blogs">Loading events...</div>
                </div>
            </div>
        </div>

        <div class="footer-info">
            <p>¬© 2025 Masters of Minds - Admin Panel | Last login: <span id="lastLogin">--</span></p>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = "https://mxzvrpvgnlgarzvzgtjm.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14enZycHZnbmxnYXJ6dnpndGptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY5ODE2MTEsImV4cCI6MjA2MjU1NzYxMX0.N4Mx9kgvDBLlyCX0bPpQgSCGVfrN9g7i5ymj9wGYV4A";
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // DOM Elements - Firebase
        const loadingOverlay = document.getElementById('loadingOverlay');
        const userInfo = document.getElementById('userInfo');
        const lastLogin = document.getElementById('lastLogin');
        
        // DOM Elements - Blog
        const uploadForm = document.getElementById('uploadForm');
        const blogTitle = document.getElementById('blogTitle');
        const blogCaption = document.getElementById('blogCaption');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const uploadStatus = document.getElementById('uploadStatus');
        const blogList = document.getElementById('blogList');
        
        // Selected images for upload
        let selectedImages = [];
        
        // Show loading
        function showLoading() {
            loadingOverlay.classList.add('show');
        }
    
        // Hide loading
        function hideLoading() {
            loadingOverlay.classList.remove('show');
        }
    
        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                showLoading();
                
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    
                    // Logout successful
                    window.location.href = "login.html";
                } catch (error) {
                    hideLoading();
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        }
    
        // Format date for display
        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    
        // Initialize admin dashboard
        function initializeDashboard(user) {
            // Update user information
            const email = user.email;
            const lastLoginTime = user.last_sign_in_at;
            
            userInfo.textContent = `Logged in as: ${email}`;
            
            if (lastLoginTime) {
                const loginDate = new Date(lastLoginTime);
                lastLogin.textContent = formatDate(loginDate);
            } else {
                lastLogin.textContent = formatDate(new Date());
            }
            
            // Load blogs
            loadBlogs();
            
            // Setup image input
            setupImageInput();
        
            // Hide loading overlay
            hideLoading();
        }
        
        function setupImageInput() {
            imageInput.addEventListener('change', () => {
                if (imageInput.files.length > 4) {
                    showStatus('You can only upload up to 4 images per blog post.', 'error');
                    imageInput.value = '';
                    return;
                }
                
                // Clear previous selections
                selectedImages = [];
                imagePreview.innerHTML = '';
                
                // Add selected files to array and display previews
                Array.from(imageInput.files).forEach(file => {
                    selectedImages.push(file);
                    
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.onclick = () => {
                            const index = selectedImages.indexOf(file);
                            if (index > -1) {
                                selectedImages.splice(index, 1);
                                previewItem.remove();
                            }
                        };
                        
                        previewItem.appendChild(img);
                        previewItem.appendChild(removeBtn);
                        imagePreview.appendChild(previewItem);
                    };
                    
                    reader.readAsDataURL(file);
                });
            });
        }
        
        // Handle form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (selectedImages.length === 0) {
                showStatus('Please select at least one image.', 'error');
                return;
            }
            
            // Check if blog limit is reached
            const blogCount = await countBlogs();
            if (blogCount >= 40) {
                showStatus('You have reached the maximum limit of 40 blogs. Please delete some blogs before adding more.', 'error');
                return;
            }
            
            // Show loading status
            showLoading();
            showStatus('Uploading blog post...', '');
            
            try {
                // Generate a new blog ID
                const blogId = uuid.v4();
                
                // Upload images and save blog post
                await uploadBlogPost(blogId);
                
                // Clear form
                uploadForm.reset();
                imagePreview.innerHTML = '';
                selectedImages = [];
                
                showStatus('Blog post uploaded successfully!', 'success');
                
                // Reload blogs
                loadBlogs();
                hideLoading();
            } catch (error) {
                console.error('Error uploading blog post:', error);
                showStatus('Failed to upload blog post: ' + error.message, 'error');
                hideLoading();
            }
        });
        
        async function uploadBlogPost(blogId) {
            // Upload each image
            for (let i = 0; i < selectedImages.length; i++) {
                const file = selectedImages[i];
                
                // Create a unique file name
                const fileExt = file.name.split('.').pop();
                const fileName = `${uuid.v4()}.${fileExt}`;
                const filePath = `public/${fileName}`;
                
                // Upload file to Supabase Storage
                const { error: uploadError } = await supabaseClient.storage
                    .from('images')
                    .upload(filePath, file);
                    
                if (uploadError) throw uploadError;
                
                // Get the public URL
                const { data } = supabaseClient.storage
                    .from('images')
                    .getPublicUrl(filePath);
                    
                const publicUrl = data.publicUrl;
                    
                // Store image metadata in Supabase database
                const { error: dbError } = await supabaseClient
                    .from('image_gallery')
                    .insert([
                        {
                            title: blogTitle.value,
                            caption: blogCaption.value,
                            file_path: filePath,
                            url: publicUrl,
                            uploaded_at: new Date(),
                            blog_id: blogId
                        }
                    ]);
                    
                if (dbError) throw dbError;
            }
        }
        
        async function loadBlogs() {
            try {
                // Get all blog posts
                const { data, error } = await supabaseClient
                    .from('image_gallery')
                    .select('*')
                    .order('uploaded_at', { ascending: false });
                
                if (error) throw error;
                
                // Group images by blog_id
                const blogGroups = {};
                data.forEach(item => {
                    if (!blogGroups[item.blog_id]) {
                        blogGroups[item.blog_id] = {
                            id: item.blog_id,
                            title: item.title,
                            uploaded_at: item.uploaded_at
                        };
                    }
                });
                
                // Convert to array and sort by date (newest first)
                const blogs = Object.values(blogGroups).sort((a, b) => 
                    new Date(b.uploaded_at) - new Date(a.uploaded_at)
                );
                
                renderBlogs(blogs);
                
            } catch (error) {
                console.error('Error loading blogs:', error);
                blogList.innerHTML = `<div class="no-blogs">Error loading blogs: ${error.message}</div>`;
            }
        }
        
        function renderBlogs(blogs) {
            blogList.innerHTML = '';
            
            if (blogs.length === 0) {
                blogList.innerHTML = '<div class="no-blogs">No blogs posted yet.</div>';
                return;
            }
            
            blogs.forEach(blog => {
                const blogItem = document.createElement('div');
                blogItem.className = 'blog-item';
                
                const blogInfo = document.createElement('div');
                blogInfo.className = 'blog-info';
                
                const blogTitle = document.createElement('h3');
                blogTitle.textContent = blog.title;
                
                const blogDate = document.createElement('div');
                blogDate.className = 'blog-date';
                blogDate.textContent = new Date(blog.uploaded_at).toLocaleDateString();
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'button delete';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => deleteBlog(blog.id, blog.title));
                
                blogInfo.appendChild(blogTitle);
                blogInfo.appendChild(blogDate);
                
                blogItem.appendChild(blogInfo);
                blogItem.appendChild(deleteBtn);
                
                blogList.appendChild(blogItem);
            });
        }
        
        async function deleteBlog(blogId, blogTitle) {
            if (!confirm(`Are you sure you want to delete the blog "${blogTitle}"?`)) {
                return;
            }
            
            showLoading();
            
            try {
                // First, get all images for this blog
                const { data: images, error: fetchError } = await supabaseClient
                    .from('image_gallery')
                    .select('*')
                    .eq('blog_id', blogId);
                
                if (fetchError) throw fetchError;
                
                // Delete images from storage
                for (const image of images) {
                    const { error: storageError } = await supabaseClient.storage
                        .from('images')
                        .remove([image.file_path]);
                        
                    if (storageError) console.error('Error deleting image from storage:', storageError);
                }
                
                // Delete records from database
                const { error: dbError } = await supabaseClient
                    .from('image_gallery')
                    .delete()
                    .eq('blog_id', blogId);
                    
                if (dbError) throw dbError;
                
                showStatus('Blog deleted successfully!', 'success');
                
                // Reload blogs
                loadBlogs();
                hideLoading();
                
            } catch (error) {
                console.error('Error deleting blog:', error);
                showStatus('Failed to delete blog: ' + error.message, 'error');
                hideLoading();
            }
        }
        
        async function countBlogs() {
            try {
                // Count unique blog_ids
                const { data, error } = await supabaseClient
                    .from('image_gallery')
                    .select('blog_id')
                    .order('blog_id');
                
                if (error) throw error;
                
                // Count unique blog_ids
                const uniqueBlogIds = new Set();
                data.forEach(item => uniqueBlogIds.add(item.blog_id));
                
                return uniqueBlogIds.size;
                
            } catch (error) {
                console.error('Error counting blogs:', error);
                return 0;
            }
        }
        
        function showStatus(message, type) {
            uploadStatus.innerHTML = message;
            uploadStatus.className = 'status-message ' + type;
        }
    
        // Check authentication state
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) throw error;
                
                if (user) {
                    // User is signed in
                    console.log('User authenticated:', user.email);
                    initializeDashboard(user);
                    // Setup auto event deletion
                } else {
                    // No user is signed in, redirect to login
                    console.log('No user authenticated, redirecting to login');
                    window.location.href = "login.html";
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = "login.html";
            }
        }
    
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading initially
            showLoading();
            // Check authentication
            checkAuth();
        });
    
        // DOM Elements - Events
        const eventUploadForm = document.getElementById('eventUploadForm');
        const eventTitle = document.getElementById('eventTitle');
        const eventDate = document.getElementById('eventDate');
        const eventPosterInput = document.getElementById('eventPosterInput');
        const eventPosterPreview = document.getElementById('eventPosterPreview');
        const eventUploadStatus = document.getElementById('eventUploadStatus');
        const eventList = document.getElementById('eventList');
            
        // Selected poster for upload
        let selectedEventPoster = null;
            
        // Setup event poster input
        eventPosterInput.addEventListener('change', () => {
            if (eventPosterInput.files.length === 0) {
                eventPosterPreview.innerHTML = '';
                selectedEventPoster = null;
                return;
            }
            
            // Clear previous selection
            selectedEventPoster = eventPosterInput.files[0];
            eventPosterPreview.innerHTML = '';
            
            // Create preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-image';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    selectedEventPoster = null;
                    previewItem.remove();
                    eventPosterInput.value = '';
                };
                
                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                eventPosterPreview.appendChild(previewItem);
            };
            
            reader.readAsDataURL(selectedEventPoster);
        });
        
        // Handle event form submission
        eventUploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedEventPoster) {
                showEventStatus('Please select an event poster.', 'error');
                return;
            }
            
            // Check if events limit is reached
            const eventCount = await countEvents();
            if (eventCount >= 6) {
                showEventStatus('You have reached the maximum limit of 6 events. Please delete some events before adding more.', 'error');
                return;
            }
            
            // Show loading status
            showLoading();
            showEventStatus('Uploading event...', '');
            
            try {
                // Generate a new event ID
                const eventId = uuid.v4();
                
                // Upload event
                await uploadEvent(eventId);
                
                // Clear form
                eventUploadForm.reset();
                eventPosterPreview.innerHTML = '';
                selectedEventPoster = null;
                
                showEventStatus('Event uploaded successfully!', 'success');
                
                // Reload events
                loadEvents();
                hideLoading();
            } catch (error) {
                console.error('Error uploading event:', error);
                showEventStatus('Failed to upload event: ' + error.message, 'error');
                hideLoading();
            }
        });
        
        async function uploadEvent(eventId) {
            // Create a unique file name
            const file = selectedEventPoster;
            const fileExt = file.name.split('.').pop();
            const fileName = `${uuid.v4()}.${fileExt}`;
            const filePath = `public/${fileName}`;
            
            // Upload file to Supabase Storage
            const { error: uploadError } = await supabaseClient.storage
                .from('posters')
                .upload(filePath, file);
                
            if (uploadError) throw uploadError;
            
            // Get the public URL
            const { data } = supabaseClient.storage
                .from('posters')
                .getPublicUrl(filePath);
                
            const publicUrl = data.publicUrl;
                
            // Store event metadata in Supabase database
            const { error: dbError } = await supabaseClient
                .from('events')
                .insert([
                    {
                        id: eventId,
                        title: eventTitle.value,
                        event_date: eventDate.value,
                        poster_path: filePath,
                        poster_url: publicUrl,
                        created_at: new Date()
                    }
                ]);
                
            if (dbError) throw dbError;
        }
        
        async function loadEvents() {
            try {
                // Get all events
                const { data, error } = await supabaseClient
                    .from('events')
                    .select('*')
                    .order('event_date', { ascending: true });
                
                if (error) throw error;
                
                renderEvents(data);
                
            } catch (error) {
                console.error('Error loading events:', error);
                eventList.innerHTML = `<div class="no-blogs">Error loading events: ${error.message}</div>`;
            }
        }
        
        function renderEvents(events) {
            eventList.innerHTML = '';
            
            if (events.length === 0) {
                eventList.innerHTML = '<div class="no-blogs">No events posted yet.</div>';
                return;
            }
            
            events.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'blog-item';  // Changed from event-item to blog-item for consistent styling
                
                const eventInfo = document.createElement('div');
                eventInfo.className = 'blog-info';  // Changed from event-info to blog-info for consistent styling
                
                const eventTitleElem = document.createElement('h3');
                eventTitleElem.textContent = event.title;
                
                const eventDateElem = document.createElement('div');
                eventDateElem.className = 'blog-date';  // Changed from event-date to blog-date for consistent styling
                
                // Format date nicely
                const dateObj = new Date(event.event_date);
                const formattedDate = dateObj.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                }).replace(/\//g, '/');
                
                eventDateElem.textContent = `Event Date: ${formattedDate}`;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'button delete';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => deleteEvent(event.id, event.title));
                
                eventInfo.appendChild(eventTitleElem);
                eventInfo.appendChild(eventDateElem);
                
                eventItem.appendChild(eventInfo);
                eventItem.appendChild(deleteBtn);
                
                eventList.appendChild(eventItem);
            });
        }
        
        async function deleteEvent(eventId, eventTitle) {
            if (!confirm(`Are you sure you want to delete the event "${eventTitle}"?`)) {
                return;
            }
            
            showLoading();
            
            try {
                // First, get the event to get the file path
                const { data: event, error: fetchError } = await supabaseClient
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                // Delete poster from storage
                const { error: storageError } = await supabaseClient.storage
                    .from('posters')
                    .remove([event.poster_path]);
                    
                if (storageError) console.error('Error deleting poster from storage:', storageError);
                
                // Delete event from database
                const { error: dbError } = await supabaseClient
                    .from('events')
                    .delete()
                    .eq('id', eventId);
                    
                if (dbError) throw dbError;
                
                showEventStatus('Event deleted successfully!', 'success');
                
                // Reload events
                loadEvents();
                hideLoading();
                
            } catch (error) {
                console.error('Error deleting event:', error);
                showEventStatus('Failed to delete event: ' + error.message, 'error');
                hideLoading();
            }
        }
        
        async function countEvents() {
            try {
                // Count events
                const { data, error, count } = await supabaseClient
                    .from('events')
                    .select('*', { count: 'exact', head: true });
                
                if (error) throw error;
                
                return count;
                
            } catch (error) {
                console.error('Error counting events:', error);
                return 0;
            }
        }
        
        function showEventStatus(message, type) {
            eventUploadStatus.innerHTML = message;
            eventUploadStatus.className = 'status-message ' + type;
        }
        
        
        // Initialize events
        document.addEventListener('DOMContentLoaded', function() {
            // Load events when page is loaded
            loadEvents();
        });

    </script>
</body>
</html>